<div class="top-bar">
    <h1><i class="fas fa-shopping-cart"></i> Manage Orders</h1>
    <div class="actions">
        <span class="order-count">Total: <%= orders.length %> orders</span>
    </div>
</div>

<% if (message) { %>
    <div class="alert alert-<%= messageType === 'error' ? 'error' : 'success' %>">
        <i class="fas fa-<%= messageType === 'error' ? 'exclamation-circle' : 'check-circle' %>"></i>
        <%= message %>
    </div>
<% } %>

<div class="content-box">
    <style>
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
            display: inline-block;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-primary {
            background: #0066cc;
            color: white;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-secondary {
            background: #6c757d;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-outline-info {
            background: white;
            border: 1px solid #17a2b8;
            color: #17a2b8;
        }

        .btn-outline-info:hover {
            background: #17a2b8;
            color: white;
        }

        .btn-outline-primary {
            background: white;
            border: 1px solid #0066cc;
            color: #0066cc;
        }

        .btn-outline-primary:hover {
            background: #0066cc;
            color: white;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            background: white;
            min-width: 200px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            display: block;
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .order-details {
            background: #f8f9fa;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .order-details h6 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }

        .order-items-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .order-item-info {
            flex: 1;
        }

        .order-item-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .order-item-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .order-item-price {
            font-weight: 600;
            color: #0066cc;
            font-size: 16px;
        }

        .status-rules {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .status-rules strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 8px;
        }

        .status-rules ul {
            margin: 0;
            padding-left: 20px;
            color: #6c757d;
            font-size: 13px;
        }

        .status-rules li {
            margin-bottom: 5px;
        }

        .no-orders {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .order-count {
            color: #6c757d;
            font-size: 14px;
        }

        .collapse {
            display: none;
        }

        .collapse.show {
            display: table-row;
        }
    </style>

    <% if (orders.length > 0) { %>
        <table class="orders-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Email</th>
                    <th>Date</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% orders.forEach(order => { %>
                    <tr>
                        <td>
                            <small style="color: #6c757d;">#<%= order._id.toString().substring(0, 8) %>...</small>
                        </td>
                        <td><%= order.email %></td>
                        <td><%= new Date(order.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></td>
                        <td><strong>$<%= order.totalAmount.toFixed(2) %></strong></td>
                        <td>
                            <% 
                                let statusClass = 'badge-secondary';
                                if (order.status === 'Placed') statusClass = 'badge-info';
                                if (order.status === 'Processing') statusClass = 'badge-warning';
                                if (order.status === 'Shipped') statusClass = 'badge-primary';
                                if (order.status === 'Delivered') statusClass = 'badge-success';
                                if (order.status === 'Cancelled') statusClass = 'badge-danger';
                            %>
                            <span class="badge <%= statusClass %>">
                                <%= order.status %>
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <!-- View Details Button -->
                                <button class="btn btn-sm btn-outline-info" type="button" onclick="toggleOrderDetails('<%= order._id %>')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                
                                <!-- Status Update Dropdown - Only show if order can be updated -->
                                <% if (order.status === 'Placed' || order.status === 'Processing') { %>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-primary" type="button">
                                            <i class="fas fa-edit"></i> Update
                                        </button>
                                        <div class="dropdown-menu">
                                            <% if (order.status === 'Placed') { %>
                                                <form action="/admin/order/<%= order._id %>/status" method="POST" style="margin: 0;">
                                                    <input type="hidden" name="status" value="Processing">
                                                    <button type="submit" class="dropdown-item">
                                                        <i class="fas fa-arrow-right" style="color: #ffc107;"></i> Mark as Processing
                                                    </button>
                                                </form>
                                            <% } %>
                                            <% if (order.status === 'Processing') { %>
                                                <form action="/admin/order/<%= order._id %>/status" method="POST" style="margin: 0;">
                                                    <input type="hidden" name="status" value="Delivered">
                                                    <button type="submit" class="dropdown-item">
                                                        <i class="fas fa-check" style="color: #28a745;"></i> Mark as Delivered
                                                    </button>
                                                </form>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <button class="btn btn-sm btn-secondary" disabled>
                                        <i class="fas fa-lock"></i> Locked
                                    </button>
                                <% } %>
                            </div>
                        </td>
                    </tr>
                    <!-- Order Details Row -->
                    <tr class="collapse" id="order-details-<%= order._id %>">
                        <td colspan="6">
                            <div class="order-details">
                                <h6><i class="fas fa-box"></i> Order Items:</h6>
                                <ul class="order-items-list">
                                    <% order.products.forEach(product => { %>
                                        <li class="order-item">
                                            <div class="order-item-info">
                                                <div class="order-item-name"><%= product.name %></div>
                                                <div class="order-item-meta">
                                                    Quantity: <%= product.quantity %> × $<%= product.price.toFixed(2) %>
                                                </div>
                                            </div>
                                            <div class="order-item-price">
                                                $<%= (product.price * product.quantity).toFixed(2) %>
                                            </div>
                                        </li>
                                    <% }); %>
                                </ul>
                                <div class="status-rules">
                                    <strong>Status Transition Rules:</strong>
                                    <ul>
                                        <li>Placed → Can only move to <strong>Processing</strong></li>
                                        <li>Processing → Can only move to <strong>Delivered</strong></li>
                                        <li>Delivered → Cannot be changed (final state)</li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    <% } else { %>
        <div class="no-orders">
            <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3>No orders found</h3>
            <p>Orders will appear here once customers place them</p>
        </div>
    <% } %>
</div>

<script>
    function toggleOrderDetails(orderId) {
        const detailsRow = document.getElementById('order-details-' + orderId);
        if (detailsRow.classList.contains('show')) {
            detailsRow.classList.remove('show');
        } else {
            // Close all other open details
            document.querySelectorAll('.collapse.show').forEach(el => {
                el.classList.remove('show');
            });
            detailsRow.classList.add('show');
        }
    }
</script>


<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BeShop CRUD</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- jQuery (required by this assignment) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Bootstrap Bundle JS (includes Popper for toasts/modals) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body { padding-top: 2rem; padding-bottom: 4rem; }
    .spinner-center { display:flex; justify-content:center; padding:1rem; }
    .table-wrap { max-height:60vh; overflow:auto; }
    .cursor-pointer { cursor:pointer; }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3">CRUD Demo</h1>
    <div>
      <button id="btn-add-new" class="btn btn-primary">Add New Post</button>
      <button id="btn-refresh" class="btn btn-outline-secondary">Refresh</button>
    </div>
  </div>

  <!-- Alerts area (fallback) -->
  <div id="alerts"></div>

  <!-- Loading spinner -->
  <div id="loading" class="spinner-center" style="display:none;">
    <div class="spinner-border" role="status" aria-hidden="true"></div>
    <span class="ms-2">Loading...</span>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-wrap">
        <table id="posts-table" class="table table-hover mb-0" >
          <thead class="table-light position-sticky top-0">
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Body</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- rows inserted dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

 
</div>

<!-- Modal for Create / Edit -->
<div class="modal fade" id="postModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="postForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="postId" value="">
        <div class="mb-3">
          <label for="postTitle" class="form-label">Title</label>
          <input id="postTitle" class="form-control" required maxlength="150">
        </div>
        <div class="mb-3">
          <label for="postBody" class="form-label">Body</label>
          <textarea id="postBody" class="form-control" rows="4" required maxlength="1000"></textarea>
        </div>
        <div id="modalSpinner" class="spinner-border spinner-border-sm text-primary" role="status" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="saveBtn" type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
  <div id="toastContainer" class="toast-container"></div>
</div>

<script>
$(function(){
    // Simple configuration
    const config = {
        api: 'https://jsonplaceholder.typicode.com/posts',
        table: '#posts-table tbody',
        form: '#postForm',
        modal: '#postModal'
    };

    // Store posts data
    let posts = [];
    let nextId = 1;
    
    // Load posts from API
    function loadPosts() {
        $('#loading').show();
        $.get(config.api)
            .done(data => {
                posts = data;
                nextId = Math.max(...posts.map(p => p.id)) + 1;
                renderTable();
            })
            .fail(() => alert('Failed to load posts'))
            .always(() => $('#loading').hide());
    }

    // Render posts table
    function renderTable() {
        const rows = posts.map(post => `
            <tr data-id="${post.id}">
                <td>${post.id}</td>
                <td>${sanitize(post.title)}</td>
                <td>${sanitize(post.body)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary edit">Edit</button>
                    <button class="btn btn-sm btn-outline-danger delete ms-1">Delete</button>
                </td>
            </tr>
        `).join('');

        $(config.table).html(rows || '<tr><td colspan="4" class="text-center">No posts found</td></tr>');
    }

    // Handle form submission
    $(config.form).submit(function(e) {
        e.preventDefault();
        
        const data = {
            id: $('#postId').val() || nextId,
            title: $('#postTitle').val().trim(),
            body: $('#postBody').val().trim(),
            userId: 1
        };

        // Validate
        if (!data.title || !data.body) {
            alert('Please fill all fields');
            return;
        }

        // Update or Create
        if (data.id !== nextId) {
            updatePost(data);
        } else {
            createPost(data);
        }
    });

    // Create new post
    function createPost(data) {
        $.post(config.api, data)
            .done(() => {
                posts.push(data);
                nextId++;
                renderTable();
                hideModal();
                showMessage('Post created');
            })
            .fail(() => alert('Failed to create post'));
    }

    // Update existing post
    function updatePost(data) {
        $.ajax({
            url: `${config.api}/${data.id}`,
            method: 'PUT',
            data: data
        })
        .done(() => {
            const index = posts.findIndex(p => p.id === Number(data.id));
            posts[index] = data;
            renderTable();
            hideModal();
            showMessage('Post updated');
        })
        .fail(() => alert('Failed to update post'));
    }

    // Event Handlers
    $('#btn-add-new').click(() => {
        $(config.form).trigger('reset');
        $('#modalTitle').text('Add New Post');
        $('#postId').val('');
        showModal();
    });

    $('#btn-refresh').click(loadPosts);

    $(config.table).on('click', '.edit', function() {
        const id = $(this).closest('tr').data('id');
        const post = posts.find(p => p.id === id);
        
        $('#modalTitle').text('Edit Post');
        $('#postId').val(post.id);
        $('#postTitle').val(post.title);
        $('#postBody').val(post.body);
        showModal();
    });

    $(config.table).on('click', '.delete', function() {
        if (confirm('Delete this post?')) {
            const id = $(this).closest('tr').data('id');
            
            $.ajax({
                url: `${config.api}/${id}`,
                method: 'DELETE'
            })
            .done(() => {
                posts = posts.filter(p => p.id !== id);
                renderTable();
                showMessage('Post deleted');
            })
            .fail(() => alert('Failed to delete post'));
        }
    });

    // Helper functions
    function showModal() {
        new bootstrap.Modal(config.modal).show();
    }

    function hideModal() {
        bootstrap.Modal.getInstance(config.modal).hide();
    }

    function showMessage(text) {
        const toast = $(`
            <div class="toast align-items-center text-bg-success border-0">
                <div class="d-flex">
                    <div class="toast-body">${text}</div>
                    <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `);
        
        $('#toastContainer').append(toast);
        new bootstrap.Toast(toast[0]).show();
        toast.on('hidden.bs.toast', () => toast.remove());
    }

    function sanitize(text) {
        return text?.replace(/[&<>"']/g, c => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        }[c])) || '';
    }

    // Initialize
    loadPosts();
});
</script>
</body>
</html>
